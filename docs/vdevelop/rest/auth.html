<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Authentication and authorization - graphANNIS documentation</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">graphANNIS documentation</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="authentication-and-authorization"><a class="header" href="#authentication-and-authorization">Authentication and authorization</a></h1>
<p>The graphANNIS service uses <a href="https://jwt.io/">JSON Web Tokens (JWT)</a> to authorize access to restricted parts of the REST API.
The authorization is performed using these tokens and graphANNIS requires certain claims as payload, but how they are generated is up to the administrator of the service.
You can use an external commercial service like e.g. <a href="https://auth0.com/">Auth0</a> or install an open source solution like <a href="https://www.keycloak.org/">Keycloak</a> to generate the secret tokens.
Both services allow flexible authentication and authorization scenarios, like logging in using an institutional account or using e.g. Google or Facebook accounts, but can also be used when you simply want to generate custom users with a user-name and password.
To implement authentication with an application based on the graphANNIS API, your application will need to redirect to the login-page provided by these services when the user wants to log in.
These services then generate a JWT token which should be used as Bearer-Token in the <code>Authorization</code> header of each HTTP request to the API.</p>
<h2 id="jwt-token-verification"><a class="header" href="#jwt-token-verification">JWT Token Verification</a></h2>
<p>For an JWT token to be accepted, it must be signed.
You can choose between HMAC with SHA-256 (HS256) algorithm and a shared secret or a RSA Signature with SHA-256 (RS256) and a public and private key pair.</p>
<h3 id="hmac-with-sha-256-hs256"><a class="header" href="#hmac-with-sha-256-hs256">HMAC with SHA-256 (HS256)</a></h3>
<p>Create a random secret and add this secret as value to the <code>token_verification</code> key in the <code>[auth]</code> section in the graphANNIS configuration and in the external JWT token provider service.</p>
<pre><code class="language-toml">[auth.token_verification]
type = "HS256"
secret = "&lt;some-very-private-and-secret-key&gt;"
</code></pre>
<h3 id="rsa-signature-with-sha-256-rs256"><a class="header" href="#rsa-signature-with-sha-256-rs256">RSA Signature with SHA-256 (RS256)</a></h3>
<p>If you use a local account manager like Keycloak, you have to create both a private and public key pair and add the public key as value to the <code>token_verification</code> key in the <code>[auth]</code> section.</p>
<pre><code class="language-toml">[auth.token_verification]
type = "RS256"
public_key = """
-----BEGIN PUBLIC KEY-----
&lt;you can share this PEM encoded public key with everyone&gt;
-----END PUBLIC KEY-----
"""
</code></pre>
<h2 id="claims"><a class="header" href="#claims">Claims</a></h2>
<p>JWT tokens can contain the following claims:</p>
<ul>
<li><code>sub</code> (mandatory): The subject the token was issued to.</li>
<li><code>https://corpus-tools.org/annis/groups</code>: A possible empty list of strings to which corpus groups the subject belongs to. All users (even when not logged-in) are part of the <code>anonymous</code> group. You can use the API to configure which groups have access to which corpus.</li>
<li><code>exp</code>: An optional expiration date as unix timestamp in seconds since epoch and UTC.</li>
<li><code>https://corpus-tools.org/annis/roles</code>: A list of roles this user has. If the user is an administrator, this user must have the "admin" role.</li>
</ul>
<h2 id="configuring-groups-and-corpora"><a class="header" href="#configuring-groups-and-corpora">Configuring groups and corpora</a></h2>
<p>Which corpora can be accessed for members of a certain group is stored in a small SQLite database.
The location of the database file is part of the <a href="configuration.html#database-section">database section of the configuration</a>.
You can alter this database with the <a href="https://sqlite.org/cli.html">SQLite command line tool</a> or a graphical interface like the <a href="https://sqlitebrowser.org/">DB Browser for SQLite</a>.</p>
<p>When started, the graphANNIS web service creates two tables in the database:</p>
<ul>
<li><code>groups</code> contains the names of all groups (in the <code>name</code> column)</li>
<li><code>corpus_groups</code> maps the group name (<code>group</code> column) to the corpus name (<code>corpus</code> column)</li>
</ul>
<p>Thus, to add a corpus (e.g. named "pcc2") to a group (e.g. named "anonymous"), you can modify the two tables using a graphical user interface or open the configured database file with the SQLite command line:</p>
<pre><code class="language-bash">sqlite3 service.sqlite
</code></pre>
<p>Then execute the following SQL (adjust the group and corpus names):</p>
<pre><code class="language-sql">INSERT OR IGNORE INTO groups(name) VALUES('anonymous');
INSERT INTO corpus_groups("group", corpus) VALUES('anonymous', 'pcc2');
</code></pre>
<h2 id="allowing-anonymous-access-to-all-corpora"><a class="header" href="#allowing-anonymous-access-to-all-corpora">Allowing anonymous access to all corpora</a></h2>
<p>Configuring an authorization service can be a lot of work, especially when all corpora should be accessible without any authorization.
In this case, you can set the <code>anonymous_access_all_corpora</code> parameter in the <code>[auth]</code> section to <code>true</code>.
All corpora will be readable by the REST-API calls without any authorization.</p>
<h2 id="creating-jwt-tokens-for-development-or-testing"><a class="header" href="#creating-jwt-tokens-for-development-or-testing">Creating JWT tokens for development or testing</a></h2>
<p>If you don't want to rely on web services like <a href="https://auth0.com/">Auth0</a> or <a href="http://jwt.io">jwt.io</a> when testing the graphANNIS API, you can use a command line tool to generate new JWT token.
In our case, we will use the <a href="https://github.com/mike-engel/jwt-cli">https://github.com/mike-engel/jwt-cli</a> project which also provides <a href="https://github.com/mike-engel/jwt-cli/releases/latest">pre-compiled binaries</a> for most operating systems.</p>
<p>Generate a random secret, add it to you configuration file as <code>HS256</code> token verification.
To create a token for an adminstrator user, simply execute</p>
<pre><code class="language-bash">jwt encode --secret "&lt;some-very-private-and-secret-key&gt;" --sub someone -- '{"https://corpus-tools.org/annis/roles": ["admin"]}'
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../rest/configuration.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../cli.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../rest/configuration.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../cli.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
